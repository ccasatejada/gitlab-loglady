spec:
  inputs:
    MILESTONE_NAME:
      description: "ex: 23/10/2025"
      default: null
      type: string
---
stages:
  - changelog

variables:
  PYTHON_VERSION: "3.11"
  # Ces variables sont automatiquement charg√©es depuis les CI/CD Variables
  # GITLAB_URL: d√©finie dans Settings > CI/CD > Variables
  # GITLAB_TOKEN: d√©finie dans Settings > CI/CD > Variables
  # GITLAB_GROUP_ID: d√©finie dans Settings > CI/CD > Variables
  # SLACK_WEBHOOK_URL: d√©finie dans Settings > CI/CD > Variables
  # SLACK_CHANNEL: d√©finie dans Settings > CI/CD > Variables

changelog_complete:
  stage: changelog
  image: python:${PYTHON_VERSION}-slim
  tags:
    - deploy_shell
  before_script:
    - apt-get update && apt-get install -y git
    - pip install --no-cache-dir -r requirements.txt
    - |
      git config --global user.email "gitlab-ci@email.com"
      git config --global user.name "GitLab CI"
  script:
    - |
      echo "=== Step 1/3: Validating configuration ==="
      if [ -z "$GITLAB_TOKEN" ]; then
        echo "Error: GITLAB_TOKEN not set in CI/CD variables"
        exit 1
      fi

      if [ -z "$SLACK_WEBHOOK_URL" ]; then
        echo "Error: SLACK_WEBHOOK_URL not set in CI/CD variables"
        exit 1
      fi
      
      if [ -z "$[[ inputs.MILESTONE_NAME ]]" ]; then
        echo "Error: MILESTONE_NAME not set. Please provide it when running the pipeline."
        exit 1
      fi

      echo "‚úÖ Configuration validated"
      echo ""

      echo "=== Step 2/3: Generating and publishing to Slack ==="
      python generate_changelog.py \
        --milestone "$[[ inputs.MILESTONE_NAME ]]"

      echo "‚úÖ Changelog generated and published to Slack"
      echo ""

      echo "=== Step 3/3: Committing to repository ==="

      git add changelog_archive/ changelog.md
      if git diff --cached --quiet; then
        echo "‚ÑπÔ∏è No changes to commit"
      else
        git commit -m "Update changelog.md for milestone $[[ inputs.MILESTONE_NAME ]]"
        git push https://gitlab-ci-token:${CI_JOB_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git HEAD:${CI_COMMIT_BRANCH}
        echo "‚úÖ Changes committed and pushed"
      fi

      echo ""
      echo "üéâ Changelog process completed successfully!"
  artifacts:
    paths:
      - changelog.md
      - changelog_archive/
    expire_in: 1 week
    when: always
  rules:
    - if: '$CI_PIPELINE_SOURCE == "web"'
      when: manual
    - if: '$CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "master"'
      when: manual